name: Deploy Ollama API with Cloudflare Tunnel

on:
  workflow_dispatch:

jobs:
  serve-ollama:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install & Start Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          nohup ollama serve > ollama.log 2>&1 &

      - name: Pull TranslateGemma 27B
        run: ollama pull translategemma:27b
    
      - name: Setup Cloudflare Tunnel
        env:
          CLOUDFLARE_TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
        run: |
          # Download cloudflared
          curl -L -o cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
      
          # Install
          sudo dpkg -i cloudflared.deb || sudo apt --fix-broken install -y
      
          # Start tunnel (forward to Ollama port 11434)
          nohup cloudflared tunnel run --token "$CLOUDFLARE_TUNNEL_TOKEN" --url http://localhost:11434 > cf.log 2>&1 &

      - name: Keep Alive
        run: |
          echo "Model: TranslateGemma:27b"
          tail -f ollama.log
