name: Deploy Ollama API with Cloudflare Tunnel

on:
  workflow_dispatch:

jobs:
  serve-ollama:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------
      # 1) Pull source
      # ------------------------------
      - name: Checkout Code
        uses: actions/checkout@v4

      # ------------------------------
      # 2) Restore Ollama Model Cache
      # ------------------------------
      - name: Cache Ollama Models & Layers
        uses: actions/cache@v4
        id: ollama-cache
        with:
          path: |
            /usr/share/ollama/.ollama/models
            /usr/share/ollama/.ollama/layers
          key: ollama-cache-${{ runner.os }}-v1

      # ------------------------------
      # 3) Install Ollama
      # ------------------------------
      - name: Install & Start Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          sudo mkdir -p /usr/share/ollama/.ollama
          sudo chown -R $USER:$USER /usr/share/ollama/.ollama
          nohup ollama serve > ollama.log 2>&1 &

      # ------------------------------
      # 4) Pull Model (skip if cached)
      # ------------------------------
      - name: Pull TranslateGemma 27B
        if: steps.ollama-cache.outputs.cache-hit != 'true'
        run: |
          echo "Cache MISS â†’ pulling model..."
          ollama pull translategemma:27b

      - name: Verify Cache Contents
        run: |
          echo "Models:"
          ls -lh /usr/share/ollama/.ollama/models || true
          echo "Layers:"
          ls -lh /usr/share/ollama/.ollama/layers || true

      # ------------------------------
      # 5) Install ngrok (cached apt)
      # ------------------------------
      - name: Cache apt packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt/archives
          key: apt-cache-ngrok-${{ runner.os }}

      - name: Install Ngrok
        run: |
          curl -sSL https://ngrok-agent.s3.amazonaws.com/ngrok.asc \
            | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com bookworm main" \
            | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update
          sudo apt install -y ngrok
          ngrok config add-authtoken ${{ secrets.NGROK_TOKEN }}
          nohup ngrok http 11434 --log=stdout > ngrok.log 2>&1 &

      # ------------------------------
      # 7) Print Ollama Log Forever
      # ------------------------------
      - name: Run Server
        run: |
          echo "Model: TranslateGemma:27b"
          tail -f ollama.log
